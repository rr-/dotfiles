#!/bin/python3
# Used for capturing screen as video.

import os
import argparse
import re
import time
from subprocess import run, PIPE


def parse_args():
    parser = argparse.ArgumentParser(description='Capture selected window')
    parser.add_argument(
        metavar='PATH', nargs='?', dest='output_path',
        help='where to save the output stream',
        default=os.path.expanduser('~/output.webm'))
    parser.add_argument(
        '-s', '--sleep', metavar='NUM', nargs='?', dest='sleep',
        type=int, default=5, help='how many seconds to wait before starting')
    return parser.parse_args()


def get_integer(result, prefix_pattern):
    return int(re.search(prefix_pattern + r'.*?(\d+)', result, re.I).group(1))


def main(args):
    result = run(['xwininfo'], stdout=PIPE).stdout.decode()
    x = get_integer(result, 'absolute.*x')
    y = get_integer(result, 'absolute.*y')
    width = get_integer(result, 'width')
    height = get_integer(result, 'height')
    border = get_integer(result, 'border')

    width += 2 * border
    height += 2 * border

    for i in range(args.sleep):
        print('Recording in', args.sleep - i)
        time.sleep(1)
    print('Go!')

    run(['ffmpeg',
        '-video_size', '{width}x{height}'.format(width=width, height=height),
        '-framerate', '25',
        '-f', 'x11grab',
        '-i', ':0.0+{x},{y}'.format(x=x, y=y),
        '-c:v', 'libvpx-vp9',
        '-y',
        # '-lossless', '1',
        args.output_path])


if __name__ == '__main__':
    main(parse_args())
