#!/usr/bin/env python3
import json
import re
import typing as T
import urllib.parse
import urllib.request

import click

DEFAULT_MAX_DEFINITIONS = 3


def wrap_long_text(text: str, length: int = 70) -> str:
    return "\n".join(
        line.strip() for line in re.findall(r".{1,%d}(?:\s+|$)" % length, text)
    )


def lookup_word(word: str) -> T.Dict[str, T.Any]:
    url = "http://api.urbandictionary.com/v0/define?term=%s" % (
        urllib.parse.quote(word)
    )
    with urllib.request.urlopen(url) as handle:
        return json.loads(handle.read().decode())


def print_definition(
    definition: T.Dict[str, T.Any], max_definitions: int
) -> None:
    if not definition["list"]:
        print("Nothing found")
        return

    for entry in list(
        sorted(definition["list"], key=lambda item: -item["thumbs_up"])
    )[0:max_definitions]:
        print("Definition:")
        print(wrap_long_text(entry["definition"]))
        print()
        print("Example:")
        print(wrap_long_text(entry["example"]))
        print("+%d -%d" % (entry["thumbs_up"], entry["thumbs_down"]))
        print()
        print("-" * 50)
        print()


@click.command()
@click.option(
    "-n",
    "--num",
    type=int,
    default=DEFAULT_MAX_DEFINITIONS,
    help="How many definitions to print.",
)
@click.argument("words", nargs=-1)
def cli(words: T.List[str], num: int) -> None:
    """Look up word definitions on Urban Dictionary."""
    for word in words:
        definition = lookup_word(word)
        print_definition(definition, max_definitions=num)


if __name__ == "__main__":
    cli()
