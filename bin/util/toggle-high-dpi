#!/usr/bin/env python3
import re
from decimal import Decimal
from subprocess import run

import yaml

from libdotfiles.util import HOME_DIR

SCALE_FACTOR = Decimal("1.5")
DPI_NORMAL = 96
DPI_HIGH = int(DPI_NORMAL * SCALE_FACTOR)


class BaseExecutor:
    def get(self) -> bool:
        raise NotImplementedError("not implemented")

    def set(self, is_enabled: bool) -> None:
        raise NotImplementedError("not implemented")


class WeztermExecutor(BaseExecutor):
    def __init__(self) -> None:
        self.config_path = HOME_DIR / ".config" / "wezterm" / "runtime.lua"

    def get_config(self):
        return self.config_path.read_text()

    def save_config(self, config):
        self.config_path.write_text(config)

    def get(self) -> bool:
        return self.get_dpi() > 96

    def get_dpi(self) -> float:
        config = self.get_config()
        return float(
            re.search("config\.dpi\s*=\s*(\d+(?:\.\d+)?)", config).group(1)
        )

    def set(self, is_enabled: bool) -> None:
        config = self.get_config()
        dpi = DPI_NORMAL
        if is_enabled:
            dpi *= SCALE_FACTOR
        config = re.sub(
            "config\.dpi\s*=\s*(\d+(?:\.\d+)?)", f"config.dpi = {dpi}", config
        )
        self.save_config(config)


class XFontExecutor(BaseExecutor):
    def get(self) -> bool:
        result = run(
            [
                "xfconf-query",
                "-c",
                "xsettings",
                "-p",
                "/Xft/DPI",
            ],
            capture_output=True,
            text=True,
        )
        if result.returncode != 0:
            return False
        return result.stdout.strip() != str(DPI_NORMAL)

    def set(self, is_enabled: bool) -> None:
        run(
            [
                "xfconf-query",
                "-c",
                "xsettings",
                "-n",
                "-t",
                "int",
                "-p",
                "/Xft/DPI",
                "-s",
                str(DPI_HIGH if is_enabled else DPI_NORMAL),
            ]
        )


def main() -> None:
    executors = [cls() for cls in BaseExecutor.__subclasses__()]

    is_enabled = any(executor.get() for executor in executors)
    is_enabled = not is_enabled

    for executor in executors:
        executor.set(is_enabled)


if __name__ == "__main__":
    main()
