#!/usr/bin/env -S uv run --script
#
# /// script
# requires-python = ">=3.12"
# dependencies = ["python-dateutil"]
# ///

import argparse
import re
from datetime import datetime, timedelta

import dateutil.parser


def parse_date(text: str) -> datetime:
    text = text.strip().lower()
    if text == "yesterday":
        return datetime.now() - timedelta(days=1)
    return dateutil.parser.parse(text)


def parse_relative(text: str, base: datetime) -> datetime:
    text = text.strip().lower()
    if not text or text[0] not in "+-":
        return parse_date(text)

    sign = 1 if text[0] == "+" else -1
    text = text[1:]

    unit = {
        **dict.fromkeys(("s", "sec", "secs", "second", "seconds"), 1),
        **dict.fromkeys(("m", "min", "mins", "minute", "minutes"), 60),
        **dict.fromkeys(("h", "hr", "hrs", "hour", "hours"), 3600),
        **dict.fromkeys(("d", "day", "days"), 86400),
        **dict.fromkeys(("w", "week", "weeks"), 604800),
        **dict.fromkeys(("mo", "mon", "month", "months"), 2629800),
        **dict.fromkeys(("y", "yr", "yrs", "year", "years"), 31557600),
    }

    if ":" in text and re.match(r"^\d+:\d+$", text):
        h, m = text.split(":")
        delta = timedelta(hours=int(h) * sign, minutes=int(m) * sign)
        return base + delta

    matches = re.findall(r"(\d+(?:\.\d+)?)\s*([a-z]+)?", text)
    total_seconds = 0
    for num, u in matches:
        total_seconds += float(num) * unit.get(u, 1)

    return base + timedelta(seconds=sign * total_seconds)


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser()
    parser.add_argument("date1")
    parser.add_argument("date2", default=None, nargs="?")
    return parser.parse_args()


def date_diff(date1: datetime, date2: datetime) -> float:
    return abs((date2 - date1).total_seconds())


def main() -> None:
    args = parse_args()
    date1 = parse_date(args.date1)
    date2 = parse_relative(args.date2, date1) if args.date2 else datetime.now()
    diff_seconds = date_diff(date1, date2)
    print(f"Date 1:  {date1}")
    print(f"Date 2:  {date2}")
    print(f"Seconds: {diff_seconds:.2f}")
    print(f"Minutes: {diff_seconds / 60:.2f}")
    print(f"Hours:   {diff_seconds / 3600:.2f}")
    print(f"Days:    {diff_seconds / 86400:.2f}")
    print(f"Months:  {diff_seconds / (365.25/12*86400):.2f}")
    print(f"Years:   {diff_seconds / (365.25*86400):.2f}")


if __name__ == "__main__":
    main()
