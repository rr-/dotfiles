#!/bin/python3
# Two-way backup between server and main PC.

from subprocess import run
from dotfiles import logging


def sync(source, target):
    source_machine, source_path = source.split(':', 1)
    target_machine, target_path = target.split(':', 1)

    logging.info('%s -> %s', source, target)

    run(['ssh', target_machine, 'mkdir', '-p', target_path])

    run([
        'ssh',
        '-A',
        source_machine,

        'rsync',
        '--progress',
        '--whole-file',
        '--chmod=D=rwxrxrx,F=rwrr',
        '-vaKR',
        '-xx',
        '--delete-excluded',
        '--delete-during',
        # '--dry-run',

        source_path,
        target])


def main():
    logging.info('tornado -> cyclone')
    for directory in ['src', 'blob', 'hub', 'img', 'text']:
        sync(
            'tornado:/home/rr-/' + directory,
            'cyclone:/usb1/backup/tornado/')

    logging.info('tornado -> cyclone')
    sync('cyclone:/srv/www/', 'tornado:/home/rr-/.backup/cyclone/')
    sync('cyclone:/home/rr-/text/', 'tornado:/home/rr-/.backup/cyclone/')


if __name__ == '__main__':
    main()
