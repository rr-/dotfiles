#!/usr/bin/env python3
# Two-way backup between server and main PC.

from subprocess import run
from dotfiles import logging


def sync(source, target):
    source_machine, source_path = source.split(':', 1)
    target_machine, target_path = target.split(':', 1)

    logging.info('%s -> %s', source, target)

    run(['ssh', target_machine, 'mkdir', '-p', target_path])

    status = run([
        'ssh',
        '-A',
        source_machine,

        'rsync',
        '--progress',
        '--whole-file',
        '--chmod=D=rwxrxrx,F=rwrr',
        '-vaKR',
        '-xx',
        '--delete-excluded',
        '--delete-during',
        # '--dry-run',

        source_path,
        target])

    if status.returncode != 0:
        logging.error('Error during sync, aborting')
        exit(1)


def main():
    logging.info('tornado -> cyclone')
    for directory in ['src', 'blob', 'hub', 'img', 'text']:
        sync(
            'tornado:/home/rr-/' + directory,
            'cyclone:/usb1/backup/tornado/')

    logging.info('cyclone -> tornado')
    for directory in ['/srv/www', '/home/rr-/text', '/home/rr-/.weechat/logs']:
        sync('cyclone:' + directory, 'tornado:/home/rr-/.backup/cyclone/')

    logging.info('Syncing finished without errors')


if __name__ == '__main__':
    main()
