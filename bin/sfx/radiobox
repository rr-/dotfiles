#!/bin/python3
# Plays the stations in txt/radio-stations.txt using mpv.

import os
import sys
import re
from subprocess import Popen, call, PIPE


class RadioStation():
    def __init__(self, url, title):
        self.url = url
        self.title = title


def collect_stations():
    dir_to_self = os.path.dirname(__file__)
    txt_path = os.path.join(
        dir_to_self, os.pardir, os.pardir, 'txt', 'radio-stations.txt')
    for line in open(txt_path, 'r'):
        line = re.sub('#.*', '', line).strip()
        if not line:
            continue
        title, url = line.split('|')
        title = title.strip()
        url = url.strip()
        yield RadioStation(url, title)


def choose_station(stations):
    process = Popen(['fzf'], stdin=PIPE, stdout=PIPE)
    stdin = '\n'.join([station.title for station in stations])
    stdout, _stderr = process.communicate(input=stdin.encode())
    stdout = stdout.strip().decode()
    for station in stations:
        if station.title == stdout:
            return station
    return None


def main():
    stations = list(collect_stations())
    station = choose_station(stations)
    if not station:
        print('Cancelled.', file=sys.stderr)
        sys.exit(1)
    call(['mpv', '--quiet', station.url])


if __name__ == '__main__':
    main()
